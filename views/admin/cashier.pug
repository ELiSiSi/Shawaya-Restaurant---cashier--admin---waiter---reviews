extends base

block content
  .allBills
    if orders && orders.length > 0
      each order in orders
        .invoice
          .invoice-header
            h2 Ù…Ø·Ø¹Ù… Ø´ÙˆÙŠØ©
            p.invoice-date ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: #{new Date(order.createdAt || Date.now()).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}
            p.invoice-number Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: #{order.numberOrder || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}

          .invoice-section
            h3 ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            if order.name && order.name !== ''
              .invoice-row
                span.label Ø§Ù„Ø§Ø³Ù…:
                span.value #{order.name}
              .invoice-row
                span.label Ø§Ù„Ù‡Ø§ØªÙ:
                span.value #{order.number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
              .invoice-row
                span.label Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:
                span.value #{order.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
              if order.notes && order.notes !== ""
                .invoice-row
                  span.label Ù…Ù„Ø­ÙˆØ¸Ø©:
                  span.value #{order.notes}
            else
              .invoice-row
                span.label Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ù‡:
                span.value #{order.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
              if order.notes && order.notes !== ""
                .invoice-row
                  span.label Ù…Ù„Ø­ÙˆØ¸Ø©:
                  span.value #{order.notes}

          .invoice-section
            h3 ğŸ›’ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
            table.invoice-table
              thead
                tr
                  th Ø§Ù„Ù…Ù†ØªØ¬
                  th Ø§Ù„ÙƒÙ…ÙŠØ©
                  th Ø§Ù„Ø³Ø¹Ø±
                  th Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
              tbody
                if order.cart && order.cart.length > 0
                  each item in order.cart
                    tr
                      td #{item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                      td #{item.quantity || 1}
                      td #{(item.price || 0).toFixed(2)} Ø¬Ù†ÙŠÙ‡
                      td #{((item.quantity || 1) * (item.price || 0)).toFixed(2)} Ø¬Ù†ÙŠÙ‡
                else
                  tr
                    td(colspan="4", style="text-align:center; color:#999;")
                      | Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨

          .invoice-footer
            .invoice-total
              span.total-label ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:
              span.total-value #{order.total || 0} Ø¬Ù†ÙŠÙ‡
            .invoice-status
              span.label Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:
              span.status-badge(class=order.status || 'pending')
                | #{order.status || 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}

          .invoice-actions
            button.action-btn.print(type="button" data-id=order._id)
              i.fa.fa-print
              | Ø·Ø¨Ø§Ø¹Ø©
            button.action-btn.done(type="button" data-id=order._id)
              i.fa.fa-check
              | ØªÙ… Ø§Ù„Ø¯ÙØ¹
            button.action-btn.cancel(type="button" data-id=order._id)
              i.fa.fa-times
              | Ù„Ù… ÙŠØªÙ…
    else
      p(style="text-align:center; color:#999; margin-top:20px;")
        | Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§


  script.
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.action-btn');
      if (!btn) return;

      const orderId = btn.dataset.id;

      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      if (btn.classList.contains('print')) {
        printInvoice(orderId);
        return;
      }

      let paying = 'pending';
      if (btn.classList.contains('done')) paying = true;
      if (btn.classList.contains('cancel')) paying = false;

      try {
        const res = await fetch(`/api/v1/order/${orderId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paying })
        });

        if (res.ok) {
          location.reload();
        } else {
          alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
        }
      } catch (err) {
        alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
      }
    });

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    function printInvoice(orderId) {
      const invoice = document.querySelector(`[data-id="${orderId}"]`).closest('.invoice');

      const printWindow = window.open('', '_blank', 'width=800,height=600');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
          <meta charset="UTF-8">
          <title>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨</title>
          <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
              font-family: "Cairo", sans-serif;
            }
            body {
              padding: 20px;
              background: white;
              text-align: right;
              color: #000;
            }
            .invoice {
              max-width: 800px;
              margin: 0 auto;
            }
            .invoice-header {
              text-align: center;
              border-bottom: 3px solid #FF2400;
              padding-bottom: 20px;
              margin-bottom: 30px;
            }
            .invoice-header h2 {
              font-size: 32px;
              color: #FF2400;
              margin-bottom: 10px;
              text-align: center;
            }
            .invoice-date, .invoice-number {
              text-align: center;
              font-size: 14px;
              color: #666;
              margin: 5px 0;
            }
            .invoice-section {
              text-align: right;
              margin: 25px 0;
              padding: 20px;
              border: 2px solid #eee;
              border-radius: 10px;
            }
            .invoice-section h3 {
              text-align: right;
              color: #FF2400;
              margin-bottom: 15px;
              font-size: 20px;
            }
            .invoice-row {
              display: flex;
              justify-content: flex-start;
              gap: 10px;
              padding: 8px 0;
              border-bottom: 1px dotted #ddd;
            }
            .label {
              font-weight: bold;
              text-align: right;
              color: #333;
            }
            .value {
              color: #666;
            }
            .invoice-table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 15px;
            }
            .invoice-table th {
              background: #FF2400;
              color: white;
              padding: 12px;
              text-align: center;
            }
            .invoice-table td {
              padding: 12px;
              text-align: center;
              border-bottom: 1px solid #eee;
            }
            .invoice-footer {
              margin-top: 30px;
              padding: 20px;
              background: #f9f9f9;
              border-radius: 10px;
            }
            .invoice-total {
              display: flex;
              justify-content: flex-start;
              gap: 10px;
              font-size: 24px;
              font-weight: bold;
              color: #FF2400;
              margin-bottom: 15px;
            }
            .invoice-status {
              display: flex;
              justify-content: flex-start;
              gap: 10px;
              align-items: center;
            }
            .status-badge {
              padding: 8px 20px;
              border-radius: 20px;
              font-weight: bold;
            }
            .status-badge.pending { background-color: #ffc107; color: #222; }
            .status-badge.processing { background-color: #0dcaf0; color: white; }
            .status-badge.delivered, .status-badge.done { background-color: #28a745; color: white; }
            .status-badge.cancelled, .status-badge.cancel { background-color: #dc3545; color: white; }
            .invoice-notes {
              text-align: center;
              margin-top: 30px;
              padding-top: 20px;
              border-top: 2px dashed #ccc;
              color: #666;
            }
            .invoice-notes p {
              margin: 5px 0;
            }
            .invoice-actions {
              display: none !important;
            }
            @media print {
              body {
                padding: 0;
              }
              .invoice-section {
                page-break-inside: avoid;
              }
            }
          </style>
        </head>
        <body>
          ${invoice.outerHTML}
          <div class="invoice-notes">
            <p>ğŸ™ Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p>
            <p>Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… ØªØ¬Ø±Ø¨Ø© Ù…Ù…ØªØ¹Ø© ÙˆØ·Ø¹Ø§Ù… Ø´Ù‡ÙŠ</p>
          </div>
        </body>
        </html>
      `);

      printWindow.document.close();
      printWindow.focus();

      setTimeout(() => {
        printWindow.print();
      }, 500);
    }
